---
timestamp: 'Fri Oct 17 2025 21:19:17 GMT-0400 (Eastern Daylight Time)'
parent: '[[../20251017_211917.70e4868d.md]]'
content_id: 6a6f60529fc603dcaf1b0eff5a51cb9eaac44d8edf2913c7ace1990796439aba
---

# file: src/painlocationscoring/PainLocationScoringConcept.test.ts

```typescript
import { assertEquals, assertExists, assertNotEquals } from "jsr:@std/assert";
import { testDb } from "@utils/database.ts";
import { ID } from "@utils/types.ts";
import PainLocationScoringConcept from "./PainLocationScoringConcept.ts";
import BodyMapGenerationConcept from "../BodyMapGeneration/BodyMapGeneration.ts";

// Define generic user IDs for testing
const userA = "user:Alice" as ID;
const userB = "user:Bob" as ID;

/**
 * Helper function to simulate the integrated process of generating a map via
 * BodyMapGeneration and then making PainLocationScoringConcept aware of it
 * for its internal ownership validation.
 * This simulates the effect of a synchronization rule where PainLocationScoring
 * becomes aware of maps generated by BodyMapGeneration.
 *
 * @param bodyMapGen The BodyMapGenerationConcept instance.
 * @param painScoreConcept The PainLocationScoringConcept instance.
 * @param user The user ID for whom the map is generated.
 * @returns The ID of the generated map.
 */
async function setupMap(
  bodyMapGen: BodyMapGenerationConcept,
  painScoreConcept: PainLocationScoringConcept,
  user: ID,
): Promise<ID> {
  // 1. Generate map via BodyMapGeneration
  console.log(`\n[SETUP] Generating map for user: ${user}`);
  const generateMapResult = await bodyMapGen.generateMap({ user });
  assertNotEquals("error" in generateMapResult, true, `Map generation for ${user} should succeed.`);
  const { mapId } = generateMapResult as { mapId: ID };
  console.log(`[SETUP] Generated map ID: ${mapId} by BodyMapGeneration.`);

  // 2. Register this map with PainLocationScoring for its internal validation.
  // This uses the _addMapForTesting helper, acting as a mock for a cross-concept sync.
  const registerMapResult = await painScoreConcept._addMapForTesting({ user, map: mapId });
  assertEquals("error" in registerMapResult, false, `[SETUP] Registering map ${mapId} with PainLocationScoring for user ${user} should succeed.`);
  console.log(`[SETUP] Registered map ID: ${mapId} with PainLocationScoring for user: ${user}.`);
  return mapId;
}

Deno.test("Principle: Generate map → add region → score region → delete region → verify state at each step", async () => {
  const [db, client] = await testDb();
  const bodyMapGen = new BodyMapGenerationConcept(db);
  const painScoreConcept = new PainLocationScoringConcept(db);

  try {
    console.log("\n--- Principle Test Start ---");

    // 1. Generate map for User A using BodyMapGeneration
    const mapA = await setupMap(bodyMapGen, painScoreConcept, userA);
    assertExists(mapA, "A map ID should be returned for user A.");
    console.log(`Principle Step 1: Map ${mapA} generated and registered for ${userA}.`);

    // 2. Add a region to User A's map
    const regionName = "Left Knee";
    console.log(`\nPrinciple Step 2: Adding region '${regionName}' to map ${mapA} for user ${userA}.`);
    const addRegionResult = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName });
    assertNotEquals("error" in addRegionResult, true, "addRegion should not fail.");
    const { region: regionA } = addRegionResult as { region: ID };
    assertExists(regionA, "A region ID should be returned.");
    console.log(`Output: New Region ID: ${regionA}`);

    // Verify the region was added
    const regionsAfterAdd = await painScoreConcept._getRegionsForMap({ user: userA, map: mapA });
    assertNotEquals("error" in regionsAfterAdd, true, "_getRegionsForMap should not fail.");
    assertEquals((regionsAfterAdd as Array<any>).length, 1, "There should be exactly one region after adding.");
    assertEquals((regionsAfterAdd as Array<any>)[0]._id, regionA, "The added region's ID should match.");
    assertEquals((regionsAfterAdd as Array<any>)[0].name, regionName, "The added region's name should match.");
    console.log(`Verification: Region ${regionA} successfully added to map ${mapA}.`);

    // 3. Score the region for User A
    const scoreValue = 7;
    console.log(`\nPrinciple Step 3: Scoring region ${regionA} with value ${scoreValue} for user ${userA}.`);
    const scoreRegionResult = await painScoreConcept.scoreRegion({ user: userA, region: regionA, score: scoreValue });
    assertEquals("error" in scoreRegionResult, false, "scoreRegion should succeed.");
    console.log(`Output: Region ${regionA} scored with ${scoreValue}.`);

    // Verify the score
    const scoredRegion = await painScoreConcept._getRegion({ user: userA, region: regionA });
    assertNotEquals("error" in scoredRegion, true, "_getRegion should not fail after scoring.");
    assertEquals((scoredRegion as Array<any>).length, 1, "The scored region should be found.");
    assertEquals((scoredRegion as Array<any>)[0].score, scoreValue, `The region's score should be ${scoreValue}.`);
    console.log(`Verification: Region ${regionA} now has score ${scoreValue}.`);

    // 4. Delete the region for User A
    console.log(`\nPrinciple Step 4: Deleting region ${regionA} for user ${userA}.`);
    const deleteRegionResult = await painScoreConcept.deleteRegion({ user: userA, region: regionA });
    assertEquals("error" in deleteRegionResult, false, "deleteRegion should succeed.");
    console.log(`Output: Region ${regionA} deleted.`);

    // Verify the region is deleted
    const regionsAfterDelete = await painScoreConcept._getRegionsForMap({ user: userA, map: mapA });
    assertNotEquals("error" in regionsAfterDelete, true, "_getRegionsForMap should not fail after deletion attempt.");
    assertEquals((regionsAfterDelete as Array<any>).length, 0, "There should be no regions after deletion.");
    console.log(`Verification: Region ${regionA} successfully deleted from map ${mapA}.`);

    console.log("\n--- Principle Test End ---");
  } finally {
    await client.close();
  }
});

Deno.test("Action: addRegion requirements and effects", async () => {
  const [db, client] = await testDb();
  const bodyMapGen = new BodyMapGenerationConcept(db);
  const painScoreConcept = new PainLocationScoringConcept(db);

  try {
    console.log("\n--- addRegion Action Tests Start ---");

    // Setup: Generate a map for userA and register it with PainLocationScoring
    const mapA = await setupMap(bodyMapGen, painScoreConcept, userA);
    assertExists(mapA, "mapA should be available.");

    // Setup: Generate a map for userB and register it with PainLocationScoring
    const mapB = await setupMap(bodyMapGen, painScoreConcept, userB);
    assertExists(mapB, "mapB should be available.");

    // Test Case 1: Add region to a non-existent map ID
    const nonExistentMap = "map:nonexistent" as ID;
    console.log(`\nAction: Attempting to add region to non-existent map ID: ${nonExistentMap}`);
    const result1 = await painScoreConcept.addRegion({ user: userA, map: nonExistentMap, regionName: "Phantom Limb" });
    assertEquals("error" in result1, true, "Adding a region to a non-existent map should return an error.");
    assertEquals((result1 as { error: string }).error, `Map '${nonExistentMap}' not found for user '${userA}' or user does not own it.`, "Error message for non-existent map mismatch.");
    console.log(`Output: ${JSON.stringify(result1)} (Expected Error)`);

    // Test Case 2: Add region to a map not owned by the specified user
    console.log(`\nAction: User ${userA} attempting to add region to map ${mapB} owned by ${userB}.`);
    const result2 = await painScoreConcept.addRegion({ user: userA, map: mapB, regionName: "Stolen Map Region" });
    assertEquals("error" in result2, true, "Adding a region to another user's map should return an error.");
    assertEquals((result2 as { error: string }).error, `Map '${mapB}' not found for user '${userA}' or user does not own it.`, "Error message for unowned map mismatch.");
    console.log(`Output: ${JSON.stringify(result2)} (Expected Error)`);

    // Test Case 3: Successfully add a region to an owned map
    const regionNameSuccess = "Right Shoulder";
    console.log(`\nAction: User ${userA} successfully adding region '${regionNameSuccess}' to their map ${mapA}.`);
    const successResult = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName: regionNameSuccess });
    assertEquals("error" in successResult, false, "Adding a region to an owned map should succeed.");
    const { region: newRegionId } = successResult as { region: ID };
    assertExists(newRegionId, "A new region ID should be returned on success.");
    console.log(`Output: New Region ID: ${newRegionId}`);

    // Verify effect: The new region exists in the user's map
    const regions = await painScoreConcept._getRegionsForMap({ user: userA, map: mapA });
    assertNotEquals("error" in regions, true, "_getRegionsForMap should not fail.");
    const foundRegion = (regions as Array<any>).find((r) => r._id === newRegionId);
    assertExists(foundRegion, "The newly added region should be found in the map.");
    assertEquals(foundRegion.name, regionNameSuccess, "The name of the added region should match.");
    console.log(`Verification: Region ${newRegionId} found in map ${mapA} for user ${userA}.`);

    console.log("\n--- addRegion Action Tests End ---");
  } finally {
    await client.close();
  }
});

Deno.test("Action: scoreRegion requirements and effects", async () => {
  const [db, client] = await testDb();
  const bodyMapGen = new BodyMapGenerationConcept(db);
  const painScoreConcept = new PainLocationScoringConcept(db);

  try {
    console.log("\n--- scoreRegion Action Tests Start ---");

    // Setup: Generate maps and add regions for userA and userB
    const mapA = await setupMap(bodyMapGen, painScoreConcept, userA);
    const mapB = await setupMap(bodyMapGen, painScoreConcept, userB);

    const addRegionA1Result = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName: "Forehead" });
    const { region: regionA1 } = addRegionA1Result as { region: ID };
    assertExists(regionA1);
    console.log(`Setup: Added region ${regionA1} to map ${mapA} for user ${userA}.`);

    const addRegionB1Result = await painScoreConcept.addRegion({ user: userB, map: mapB, regionName: "Left Ankle" });
    const { region: regionB1 } = addRegionB1Result as { region: ID };
    assertExists(regionB1);
    console.log(`Setup: Added region ${regionB1} to map ${mapB} for user ${userB}.`);

    // Test Case 1: Score a non-existent region ID
    const nonExistentRegion = "region:ghost" as ID;
    console.log(`\nAction: Attempting to score non-existent region ID: ${nonExistentRegion}`);
    const result1 = await painScoreConcept.scoreRegion({ user: userA, region: nonExistentRegion, score: 5 });
    assertEquals("error" in result1, true, "Scoring a non-existent region should return an error.");
    assertEquals((result1 as { error: string }).error, `Region '${nonExistentRegion}' not found or not owned by user '${userA}'.`, "Error message for non-existent region mismatch.");
    console.log(`Output: ${JSON.stringify(result1)} (Expected Error)`);

    // Test Case 2: Score a region not owned by the specified user
    console.log(`\nAction: User ${userA} attempting to score region ${regionB1} owned by ${userB}.`);
    const result2 = await painScoreConcept.scoreRegion({ user: userA, region: regionB1, score: 8 });
    assertEquals("error" in result2, true, "Scoring another user's region should return an error.");
    assertEquals((result2 as { error: string }).error, `Region '${regionB1}' not found or not owned by user '${userA}'.`, "Error message for unowned region mismatch.");
    console.log(`Output: ${JSON.stringify(result2)} (Expected Error)`);

    // Test Case 3: Score with a value less than 1
    console.log(`\nAction: Scoring region ${regionA1} with value 0 (below min).`);
    const result3 = await painScoreConcept.scoreRegion({ user: userA, region: regionA1, score: 0 });
    assertEquals("error" in result3, true, "Scoring with value less than 1 should return an error.");
    assertEquals((result3 as { error: string }).error, "Score must be a number between 1 and 10.", "Error message for score below min mismatch.");
    console.log(`Output: ${JSON.stringify(result3)} (Expected Error)`);

    // Test Case 4: Score with a value greater than 10
    console.log(`\nAction: Scoring region ${regionA1} with value 11 (above max).`);
    const result4 = await painScoreConcept.scoreRegion({ user: userA, region: regionA1, score: 11 });
    assertEquals("error" in result4, true, "Scoring with value greater than 10 should return an error.");
    assertEquals((result4 as { error: string }).error, "Score must be a number between 1 and 10.", "Error message for score above max mismatch.");
    console.log(`Output: ${JSON.stringify(result4)} (Expected Error)`);

    // Test Case 5: Successfully score a region
    const successScore = 6;
    console.log(`\nAction: User ${userA} successfully scoring region ${regionA1} with value ${successScore}.`);
    const successResult = await painScoreConcept.scoreRegion({ user: userA, region: regionA1, score: successScore });
    assertEquals("error" in successResult, false, "Scoring with a valid value on an owned region should succeed.");
    console.log(`Output: ${JSON.stringify(successResult)} (Expected Success)`);

    // Verify effect: The region now has the assigned score
    const scoredRegion = await painScoreConcept._getRegion({ user: userA, region: regionA1 });
    assertNotEquals("error" in scoredRegion, true, "_getRegion should not fail after successful scoring.");
    assertEquals((scoredRegion as Array<any>).length, 1, "The scored region should be found.");
    assertEquals((scoredRegion as Array<any>)[0].score, successScore, `Region ${regionA1}'s score should be ${successScore}.`);
    console.log(`Verification: Region ${regionA1} confirmed with score ${successScore}.`);

    // Test Case 6: Update an existing score
    const updatedScore = 9;
    console.log(`\nAction: User ${userA} updating score for region ${regionA1} to ${updatedScore}.`);
    const updateResult = await painScoreConcept.scoreRegion({ user: userA, region: regionA1, score: updatedScore });
    assertEquals("error" in updateResult, false, "Updating an existing score should succeed.");
    console.log(`Output: ${JSON.stringify(updateResult)} (Expected Success)`);

    // Verify updated score
    const updatedScoredRegion = await painScoreConcept._getRegion({ user: userA, region: regionA1 });
    assertNotEquals("error" in updatedScoredRegion, true, "_getRegion should not fail after updating score.");
    assertEquals((updatedScoredRegion as Array<any>)[0].score, updatedScore, `Region ${regionA1}'s score should be updated to ${updatedScore}.`);
    console.log(`Verification: Region ${regionA1} confirmed updated to score ${updatedScore}.`);

    console.log("\n--- scoreRegion Action Tests End ---");
  } finally {
    await client.close();
  }
});

Deno.test("Action: deleteRegion requirements and effects", async () => {
  const [db, client] = await testDb();
  const bodyMapGen = new BodyMapGenerationConcept(db);
  const painScoreConcept = new PainLocationScoringConcept(db);

  try {
    console.log("\n--- deleteRegion Action Tests Start ---");

    // Setup: Generate maps and add regions for userA and userB
    const mapA = await setupMap(bodyMapGen, painScoreConcept, userA);
    const mapB = await setupMap(bodyMapGen, painScoreConcept, userB);

    const addRegionA1Result = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName: "Right Elbow" });
    const { region: regionA1 } = addRegionA1Result as { region: ID };
    assertExists(regionA1);
    console.log(`Setup: Added region ${regionA1} to map ${mapA} for user ${userA}.`);

    const addRegionA2Result = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName: "Left Wrist" });
    const { region: regionA2 } = addRegionA2Result as { region: ID };
    assertExists(regionA2);
    console.log(`Setup: Added region ${regionA2} to map ${mapA} for user ${userA}.`);


    const addRegionB1Result = await painScoreConcept.addRegion({ user: userB, map: mapB, regionName: "Nose" });
    const { region: regionB1 } = addRegionB1Result as { region: ID };
    assertExists(regionB1);
    console.log(`Setup: Added region ${regionB1} to map ${mapB} for user ${userB}.`);

    // Test Case 1: Delete a non-existent region ID
    const nonExistentRegion = "region:imaginary" as ID;
    console.log(`\nAction: Attempting to delete non-existent region ID: ${nonExistentRegion}`);
    const result1 = await painScoreConcept.deleteRegion({ user: userA, region: nonExistentRegion });
    assertEquals("error" in result1, true, "Deleting a non-existent region should return an error.");
    assertEquals((result1 as { error: string }).error, `Region '${nonExistentRegion}' not found or not owned by user '${userA}'.`, "Error message for non-existent region mismatch.");
    console.log(`Output: ${JSON.stringify(result1)} (Expected Error)`);

    // Test Case 2: Delete a region not owned by the specified user
    console.log(`\nAction: User ${userA} attempting to delete region ${regionB1} owned by ${userB}.`);
    const result2 = await painScoreConcept.deleteRegion({ user: userA, region: regionB1 });
    assertEquals("error" in result2, true, "Deleting another user's region should return an error.");
    assertEquals((result2 as { error: string }).error, `Region '${regionB1}' not found or not owned by user '${userA}'.`, "Error message for unowned region mismatch.");
    console.log(`Output: ${JSON.stringify(result2)} (Expected Error)`);

    // Test Case 3: Successfully delete an owned region
    console.log(`\nAction: User ${userA} successfully deleting region ${regionA1} from their map ${mapA}.`);
    const successResult = await painScoreConcept.deleteRegion({ user: userA, region: regionA1 });
    assertEquals("error" in successResult, false, "Deleting an owned region should succeed.");
    console.log(`Output: ${JSON.stringify(successResult)} (Expected Success)`);

    // Verify effect: The region no longer exists in the user's map
    const regionsAfterDelete = await painScoreConcept._getRegionsForMap({ user: userA, map: mapA });
    assertNotEquals("error" in regionsAfterDelete, true, "_getRegionsForMap should not fail after deletion.");
    assertEquals((regionsAfterDelete as Array<any>).length, 1, "There should be one region left after deleting one.");
    assertEquals((regionsAfterDelete as Array<any>)[0]._id, regionA2, "The remaining region should be regionA2.");
    console.log(`Verification: Region ${regionA1} confirmed deleted. Only ${regionA2} remains.`);

    console.log("\n--- deleteRegion Action Tests End ---");
  } finally {
    await client.close();
  }
});

Deno.test("Integrated Test: Multiple users and maps interact correctly and with proper isolation", async () => {
    const [db, client] = await testDb();
    const bodyMapGen = new BodyMapGenerationConcept(db);
    const painScoreConcept = new PainLocationScoringConcept(db);

    try {
        console.log("\n--- Multiple User/Map Interaction Test Start ---");

        // Setup maps for User A and User B
        const mapA = await setupMap(bodyMapGen, painScoreConcept, userA);
        const mapB = await setupMap(bodyMapGen, painScoreConcept, userB);

        // User A adds regions to their map
        console.log(`\nAction: User ${userA} adding regions to their map ${mapA}`);
        const addRegionA1Result = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName: "Left Hand" });
        const { region: regionA1 } = addRegionA1Result as { region: ID };
        const addRegionA2Result = await painScoreConcept.addRegion({ user: userA, map: mapA, regionName: "Right Hand" });
        const { region: regionA2 } = addRegionA2Result as { region: ID };
        assertExists(regionA1, `Region ${regionA1} should exist.`); assertExists(regionA2, `Region ${regionA2} should exist.`);
        console.log(`Output: User ${userA} added ${regionA1}, ${regionA2}.`);

        // User B adds regions to their map
        console.log(`\nAction: User ${userB} adding regions to their map ${mapB}`);
        const addRegionB1Result = await painScoreConcept.addRegion({ user: userB, map: mapB, regionName: "Left Foot" });
        const { region: regionB1 } = addRegionB1Result as { region: ID };
        assertExists(regionB1, `Region ${regionB1} should exist.`);
        console.log(`Output: User ${userB} added ${regionB1}.`);

        // User A scores their regions
        console.log(`\nAction: User ${userA} scoring their regions.`);
        const scoreA1Result = await painScoreConcept.scoreRegion({ user: userA, region: regionA1, score: 5 });
        assertEquals("error" in scoreA1Result, false, "User A scoring own region should succeed.");
        const scoreA2Result = await painScoreConcept.scoreRegion({ user: userA, region: regionA2, score: 9 });
        assertEquals("error" in scoreA2Result, false, "User A scoring own region should succeed.");
        console.log(`Output: User ${userA} scored ${regionA1} (5), ${regionA2} (9).`);


        // User B scores their region
        console.log(`\nAction: User ${userB} scoring their regions.`);
        const scoreB1Result = await painScoreConcept.scoreRegion({ user: userB, region: regionB1, score: 3 });
        assertEquals("error" in scoreB1Result, false, "User B scoring own region should succeed.");
        console.log(`Output: User ${userB} scored ${regionB1} (3).`);


        // Verify User A's regions and scores
        console.log(`\nVerification: Checking ${userA}'s regions and scores for map ${mapA}.`);
        const userARegions = await painScoreConcept._getRegionsForMap({ user: userA, map: mapA });
        assertNotEquals("error" in userARegions, true, `_getRegionsForMap for ${userA} should not fail.`);
        assertEquals((userARegions as Array<any>).length, 2, `User ${userA} should have 2 regions.`);
        assertEquals((userARegions as Array<any>).find(r => r._id === regionA1)?.score, 5, `Region ${regionA1} score for ${userA} should be 5.`);
        assertEquals((userARegions as Array<any>).find(r => r._id === regionA2)?.score, 9, `Region ${regionA2} score for ${userA} should be 9.`);
        console.log(`Verification: User ${userA} regions verified with correct scores.`);

        // Verify User B's regions and scores
        console.log(`\nVerification: Checking ${userB}'s regions and scores for map ${mapB}.`);
        const userBRegions = await painScoreConcept._getRegionsForMap({ user: userB, map: mapB });
        assertNotEquals("error" in userBRegions, true, `_getRegionsForMap for ${userB} should not fail.`);
        assertEquals((userBRegions as Array<any>).length, 1, `User ${userB} should have 1 region.`);
        assertEquals((userBRegions as Array<any>).find(r => r._id === regionB1)?.score, 3, `Region ${regionB1} score for ${userB} should be 3.`);
        console.log(`Verification: User ${userB} regions verified with correct scores.`);

        // Attempt cross-user modification (should fail)
        console.log(`\nAction: Attempting cross-user modification (User ${userA} tries to score ${userB}'s region ${regionB1}).`);
        const crossScoreResult = await painScoreConcept.scoreRegion({ user: userA, region: regionB1, score: 10 });
        assertEquals("error" in crossScoreResult, true, "User A should not be able to score User B's region.");
        assertEquals((crossScoreResult as { error: string }).error, `Region '${regionB1}' not found or not owned by user '${userA}'.`, "Error message for cross-user scoring mismatch.");
        console.log(`Output: ${JSON.stringify(crossScoreResult)} (Expected Error: User A cannot score User B's region)`);

        console.log("\n--- Multiple User/Map Interaction Test End ---");
    } finally {
        await client.close();
    }
});
```
